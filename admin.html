<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel – M. Rajesh</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
margin:0;
font-family:'Montserrat',sans-serif;
background:#111;
color:white;
}

.header{
background:#000;
padding:15px 30px;
display:flex;
justify-content:space-between;
align-items:center;
box-shadow:0 4px 10px rgba(0,0,0,0.5);
}

.header h2{
color:#ff8c00;
margin:0;
}

.logout-btn{
background:#ff8c00;
border:none;
padding:8px 15px;
color:white;
border-radius:6px;
cursor:pointer;
transition:0.3s;
}
.logout-btn:hover{
background:#ff5e00;
transform:scale(1.05);
}

.container{
padding:40px;
}

/* ===== SUMMARY CARDS ===== */

.summary-container{
display:flex;
gap:20px;
margin-bottom:30px;
}

.summary-card{
flex:1;
padding:25px;
border-radius:15px;
text-align:center;
box-shadow:0 0 25px rgba(0,0,0,0.4);
}

.summary-card h4{
margin:0;
font-weight:500;
opacity:0.8;
}

.summary-card h2{
margin-top:10px;
font-size:28px;
}

.revenue-card{
background:linear-gradient(135deg,#00b894,#00cec9);
}

.pending-card{
background:linear-gradient(135deg,#d63031,#e17055);
}

.section-box{
background:#1a1a1a;
padding:25px;
border-radius:12px;
margin-top:30px;
box-shadow:0 0 25px rgba(255,140,0,0.15);
}

input,select{
padding:8px 10px;
margin:5px;
border-radius:6px;
border:none;
outline:none;
}

button{
background:#ff8c00;
border:none;
padding:8px 14px;
color:white;
border-radius:6px;
cursor:pointer;
transition:0.3s;
}
button:hover{
background:#ff5e00;
transform:scale(1.05);
}

table{
width:100%;
margin-top:15px;
border-collapse:collapse;
background:#151515;
border-radius:10px;
overflow:hidden;
}

th{
background:#222;
color:#ff8c00;
font-weight:600;
}

th,td{
padding:12px;
border-bottom:1px solid #2c2c2c;
text-align:center;
}

tr{
transition:0.2s;
}

tr:hover{
background:#1f1f1f;
transform:scale(1.01);
}

.lock-btn{background:#d63031;}
.unlock-btn{background:#00cec9;}
.pay-btn{background:#0984e3;}

</style>
</head>

<body>

<div class="header">
<h2>Admin Panel – M. Rajesh (Managing Director)</h2>
<button class="logout-btn" onclick="logoutUser()">Logout</button>
</div>

<div class="container">

<!-- SUMMARY CARDS -->
<div class="summary-container">
  <div class="summary-card revenue-card">
    <h4>Total Revenue</h4>
    <h2 id="totalRevenue">₹ 0</h2>
  </div>

  <div class="summary-card pending-card">
    <h4>Total Pending</h4>
    <h2 id="totalPending">₹ 0</h2>
  </div>
</div>

<!-- ATTENDANCE TIME CONTROL -->
<div class="section-box">
<h3>Attendance Closing Time</h3>
<input type="number" id="closeHourInput" min="0" max="23" placeholder="Hour">
:
<input type="number" id="closeMinuteInput" min="0" max="59" placeholder="Minute">
<br>
<button onclick="updateCloseTime()">Update Closing Time</button>
<p id="timeStatus"></p>
</div>

<!-- MONTHLY ATTENDANCE -->
<div class="section-box">
<h3>Monthly Attendance Report</h3>
<input type="month" id="monthPicker">
<button onclick="generateMonthlyReport()">Generate Report</button>
<div id="monthlyReport" style="margin-top:15px;"></div>
</div>

<!-- ERP MANAGEMENT -->
<div class="section-box">
<h3>Customer ERP Management (Live)</h3>

<table>
<thead>
<tr>
<th>Customer</th>
<th>Executive</th>
<th>Total</th>
<th>Paid</th>
<th>Balance</th>
<th>Status</th>
<th>Work Status</th>
<th>Payment</th>
<th>Lock</th>
</tr>
</thead>
<tbody id="customerTable"></tbody>
</table>

</div>

</div>

<script type="module">
import { checkSession } from "./auth.js";
checkSession("admin");
</script>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs, doc, getDoc, setDoc, updateDoc, onSnapshot } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const table = document.getElementById("customerTable");

import { query, orderBy } from "firebase/firestore";

const q = query(
  collection(db,"customerPayments"),
  orderBy("createdAt","desc")
);

onSnapshot(q, (snapshot) => {

table.innerHTML = "";

let totalRevenue = 0;
let totalPending = 0;

snapshot.forEach(docSnap=>{
const data=docSnap.data();
const payments=data.payments||[];
const totalPaid=payments.reduce((sum,p)=>sum+p.amount,0);
const balance=data.totalAmount-totalPaid;
const status=balance===0?"Completed":"Pending";

totalRevenue += totalPaid;
totalPending += balance;

const workStatus = data.workStatus || "Not Completed";

table.innerHTML+=`
<tr>
<td>${data.customerName}</td>
<td>${data.executiveName}</td>
<td>₹${data.totalAmount}</td>
<td>₹${totalPaid}</td>
<td style="color:${balance===0?'#00e676':'#ff5252'}">₹${balance}</td>
<td>${status}</td>
<td>
<select onchange="updateWorkStatus('${docSnap.id}', this.value)">
<option value="Not Completed" ${workStatus==="Not Completed"?"selected":""}>Not Completed</option>
<option value="Completed" ${workStatus==="Completed"?"selected":""}>Completed</option>
</select>
</td>
<td><button class="pay-btn" onclick="addPayment('${docSnap.id}')">Add</button></td>
<td>
<button class="${data.isLocked?'unlock-btn':'lock-btn'}"
onclick="toggleLock('${docSnap.id}',${data.isLocked})">
${data.isLocked?'Unlock':'Lock'}
</button>
</td>
</tr>`;
});

document.getElementById("totalRevenue").innerText =
"₹ " + totalRevenue.toLocaleString();

document.getElementById("totalPending").innerText =
"₹ " + totalPending.toLocaleString();

});

/* ADD PAYMENT */
window.addPayment=async function(id){
const amount=prompt("Enter Payment Amount:");
if(!amount||isNaN(amount)) return;

const snap=await getDoc(doc(db,"customerPayments",id));
const data=snap.data();
const payments=data.payments||[];

payments.push({
amount:Number(amount),
date:new Date().toISOString().split("T")[0]
});

await updateDoc(doc(db,"customerPayments",id),{
payments:payments
});
};

/* LOCK / UNLOCK */
window.toggleLock=async function(id,currentState){
await updateDoc(doc(db,"customerPayments",id),{
isLocked:!currentState
});
};

window.updateWorkStatus = async function(id, value){
await updateDoc(doc(db,"customerPayments",id),{
workStatus:value
});
};

/* MONTHLY ATTENDANCE */
window.generateMonthlyReport = async function(){

const month = document.getElementById("monthPicker").value;
if(!month){ alert("Select month"); return; }

const [year, mon] = month.split("-");
const selectedYear = Number(year);
const selectedMonth = Number(mon);

const usersSnapshot = await getDocs(collection(db,"users"));
const attendanceSnapshot = await getDocs(collection(db,"attendance"));

let html = "";

usersSnapshot.forEach(userDoc=>{
const user = userDoc.data();

if(user.role === "employee"){

let present = 0;
let workingDays = 0;
let date = new Date(selectedYear, selectedMonth-1, 1);

while(date.getMonth() === selectedMonth-1){
if(date.getDay() !== 0){ workingDays++; }
date.setDate(date.getDate()+1);
}

attendanceSnapshot.forEach(attDoc=>{
const att = attDoc.data();
if(att.employeeId === userDoc.id && att.date){
const dateObj = new Date(att.date);
if(dateObj.getFullYear()===selectedYear &&
dateObj.getMonth()+1===selectedMonth){
present++;
}
}
});

const absent = workingDays - present;
const percentage = workingDays>0?((present/workingDays)*100).toFixed(2):0;

html += `
<div style="margin-bottom:10px;padding:8px;background:#222;border-radius:6px;">
<strong>${user.name}</strong><br>
Present: ${present} <br>
Absent: ${absent} <br>
Working Days: ${workingDays} <br>
Attendance: <span style="color:${percentage>=75?'#00e676':'#ff5252'}">
${percentage}%
</span>
</div>`;
}
});

document.getElementById("monthlyReport").innerHTML = html || "No records.";
};

/* ATTENDANCE SETTINGS */
async function loadClosingTime(){
const snap=await getDoc(doc(db,"settings","attendance"));
if(snap.exists()){
document.getElementById("closeHourInput").value=snap.data().closeHour??11;
document.getElementById("closeMinuteInput").value=snap.data().closeMinute??0;
}
}
loadClosingTime();

window.updateCloseTime=async function(){
const hour=parseInt(document.getElementById("closeHourInput").value);
const minute=parseInt(document.getElementById("closeMinuteInput").value);
if(isNaN(hour)||hour<0||hour>23||isNaN(minute)||minute<0||minute>59){
document.getElementById("timeStatus").innerText="Invalid time.";
return;
}
await setDoc(doc(db,"settings","attendance"),
{closeHour:hour,closeMinute:minute},{merge:true});
document.getElementById("timeStatus").innerText="Updated successfully!";
};

/* LOGOUT */
window.logoutUser=function(){
window.location.href="index.html";
};

</script>

<script type="module" src="auth.js"></script>

</body>
</html>
