<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel – M. Rajesh</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:'Montserrat',sans-serif;background:#111;color:white;}
.header{background:#000;padding:15px 30px;display:flex;justify-content:space-between;align-items:center;}
.header h2{color:#ff8c00;margin:0;}
.logout-btn{background:#ff8c00;border:none;padding:8px 15px;color:white;border-radius:5px;cursor:pointer;}
.container{padding:40px;}
.section-box{background:#1a1a1a;padding:20px;border-radius:10px;margin-top:30px;box-shadow:0 0 20px rgba(255,140,0,0.2);}
input,select{padding:8px;margin:5px;border-radius:5px;border:none;}
button{background:#ff8c00;border:none;padding:8px 12px;color:white;border-radius:5px;cursor:pointer;margin-top:5px;}
h3{color:#ff8c00;margin-top:0;}
table{width:100%;margin-top:15px;border-collapse:collapse;}
th,td{padding:8px;border:1px solid #333;text-align:center;}
.download-btn{margin-top:15px;background:#00b894;}
.lock-btn{background:#d63031;}
.unlock-btn{background:#00cec9;}
.pay-btn{background:#0984e3;}
</style>
</head>

<body>

<div class="header">
<h2>Admin Panel – M. Rajesh (Managing Director)</h2>
<button class="logout-btn" onclick="logoutUser()">Logout</button>
</div>

<div class="container">

<!-- ATTENDANCE TIME CONTROL -->
<div class="section-box">
<h3>Attendance Closing Time</h3>
<input type="number" id="closeHourInput" min="0" max="23" placeholder="Hour">
:
<input type="number" id="closeMinuteInput" min="0" max="59" placeholder="Minute">
<br>
<button onclick="updateCloseTime()">Update Closing Time</button>
<p id="timeStatus"></p>
</div>

<!-- MONTHLY ATTENDANCE -->
<div class="section-box">
<h3>Monthly Attendance Report</h3>
<input type="month" id="monthPicker">
<button onclick="generateMonthlyReport()">Generate Report</button>
<div id="monthlyReport" style="margin-top:15px;"></div>
</div>

<!-- ERP MANAGEMENT -->
<div class="section-box">
<h3>Customer ERP Management (Live)</h3>

<table>
<thead>
<tr>
<th>Customer</th>
<th>Executive</th>
<th>Total</th>
<th>Paid</th>
<th>Balance</th>
<th>Status</th>
<th>Payment</th>
<th>Lock</th>
</tr>
</thead>
<tbody id="customerTable"></tbody>
</table>

</div>

</div>

<script type="module">
import { checkSession } from "./auth.js";
checkSession("admin");
</script>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs, doc, getDoc, setDoc, updateDoc, onSnapshot } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ================= REAL-TIME CUSTOMER LISTENER ================= */

const table = document.getElementById("customerTable");

onSnapshot(collection(db,"customerPayments"), (snapshot) => {

table.innerHTML = "";

snapshot.forEach(docSnap=>{
const data=docSnap.data();
const payments=data.payments||[];
const totalPaid=payments.reduce((sum,p)=>sum+p.amount,0);
const balance=data.totalAmount-totalPaid;
const status=balance===0?"Completed":"Pending";

table.innerHTML+=`
<tr>
<td>${data.customerName}</td>
<td>${data.executiveName}</td>
<td>₹${data.totalAmount}</td>
<td>₹${totalPaid}</td>
<td style="color:${balance===0?'#00e676':'#ff5252'}">₹${balance}</td>
<td>${status}</td>
<td><button class="pay-btn" onclick="addPayment('${docSnap.id}')">Add</button></td>
<td>
<button class="${data.isLocked?'unlock-btn':'lock-btn'}"
onclick="toggleLock('${docSnap.id}',${data.isLocked})">
${data.isLocked?'Unlock':'Lock'}
</button>
</td>
</tr>`;
});

});

/* ================= ADD PAYMENT ================= */

window.addPayment=async function(id){
const amount=prompt("Enter Payment Amount:");
if(!amount||isNaN(amount)) return;

const snap=await getDoc(doc(db,"customerPayments",id));
const data=snap.data();
const payments=data.payments||[];

payments.push({
amount:Number(amount),
date:new Date().toISOString().split("T")[0]
});

await updateDoc(doc(db,"customerPayments",id),{
payments:payments
});
};

/* ================= LOCK / UNLOCK ================= */

window.toggleLock=async function(id,currentState){
await updateDoc(doc(db,"customerPayments",id),{
isLocked:!currentState
});
};

/* ================= MONTHLY ATTENDANCE ================= */

window.generateMonthlyReport=async function(){
const month=document.getElementById("monthPicker").value;
if(!month){ alert("Select month"); return; }

const [year,mon]=month.split("-");
const usersSnapshot=await getDocs(collection(db,"users"));
const attendanceSnapshot=await getDocs(collection(db,"attendance"));

let html="";

usersSnapshot.forEach(userDoc=>{
const user=userDoc.data();
if(user.role==="employee"){
let present=0;
attendanceSnapshot.forEach(attDoc=>{
const att=attDoc.data();
if(att.employeeId===userDoc.id && att.date.startsWith(`${year}-${mon}`)){
present++;
}
});
html+=`<div><strong>${user.name}</strong> — Present Days: ${present}</div>`;
}
});

document.getElementById("monthlyReport").innerHTML=html||"No records.";
};

/* ================= ATTENDANCE SETTINGS ================= */

async function loadClosingTime(){
const snap=await getDoc(doc(db,"settings","attendance"));
if(snap.exists()){
document.getElementById("closeHourInput").value=snap.data().closeHour??11;
document.getElementById("closeMinuteInput").value=snap.data().closeMinute??0;
}
}
loadClosingTime();

window.updateCloseTime=async function(){
const hour=parseInt(document.getElementById("closeHourInput").value);
const minute=parseInt(document.getElementById("closeMinuteInput").value);
if(isNaN(hour)||hour<0||hour>23||isNaN(minute)||minute<0||minute>59){
document.getElementById("timeStatus").innerText="Invalid time.";
return;
}
await setDoc(doc(db,"settings","attendance"),
{closeHour:hour,closeMinute:minute},{merge:true});
document.getElementById("timeStatus").innerText="Updated successfully!";
};

/* ================= LOGOUT ================= */

window.logoutUser=function(){
window.location.href="index.html";
};

</script>

<script type="module" src="auth.js"></script>

</body>
</html>
